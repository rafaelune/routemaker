{% extends "base-fluid.html" %}

{% block title %}VPSA - Route Maker{% endblock %}

{% block content %}
<div class="row-fluid" style="padding-top: 50px;">
    <div class="span2">
        <div class="box">
            <strong class="database-user">{{ user_profile.database }}</strong>
            <a href="#" title="Autenticado como {{ user.username }}">{{ user.username }}</a>
        </div>
        <div class="sidebar-nav">
            <div class="well" style="padding: 8px 0;">
                <ul class="nav nav-list">
                    <li class="nav-header">Op&#231;&#245;es</li>
                    <li class="active">
                        <a href="index.html">
                            <i class="icon-map-marker"></i>
                            Criar Rota
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    
    <div class="span10">
        <div class="row-fluid">
            <div class="tabbable">
                <ul class="nav nav-tabs tab-menu">
                    <li class="active"><a id="lnkTab1" href="#tab1" data-toggle="tab" onclick="visual.goToFirstTabFilter();">Etapa 1</a></li>
                    <li class="d_n"><a id="lnkTab2" href="#tab2" data-toggle="tab">Etapa 2</a></li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane active" id="tab1">
                        {% include "route/filter-form.html" %}
                    </div>
                    <div class="d_n tab-pane" id="tab2">
                        <div class="white-box">
                            <div id="my-map" class="map-normal"></div>
                        </div>

                        <div class="row">
                            <ul id="instructions">
                                <li></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>

</div>

{% endblock %}

{% block scripts %}
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.18/jquery-ui.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/bootstrap-tab.js"></script>
<script type="text/javascript" src="http://malsup.github.com/jquery.form.js"></script>

<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
<script type="text/javascript" src="https://raw.github.com/HPNeo/gmaps/master/gmaps.js"></script>
<script type="text/javascript" src="http://j.maxmind.com/app/geoip.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/mapper.js"></script>

<script type="text/javascript">
    $(document).ready(function() {
        util.createExternalLinks();
        visual.configUserMenuOptions();
        
        // prepare Options Object 
        var options = { 
            target:     '#pedidos-placeholder', 
            url:        '/filtro/', 
            beforeSubmit: function(arr, $form, options) {
                // saves the entidade id selected
                $('#my-map').data('entidade', arr[1].value);
            },
            success:    function() { 
                $('#pedidos-placeholder').sortable();
                $('#pedidos-placeholder').disableSelection();
            } 
        };
        // pass options to ajaxForm 
        $('#filterForm').ajaxForm(options);

    });

    function drawDirections(route) {
        while(route.step_count < route.steps_length) {
            route.forward();

            if(route.step_count < route.steps_length)
                $('#instructions').append('<li>'+route.steps[route.step_count].instructions+'</li>');
        }
    }
    
    function loadTab2() {
        startsLat = -23.17908;
        startsLng = -45.887248;

        visual.goToSecondTabFilter();
        //mapper.startMap('#my-map');

        // inits the map
        map = new GMaps({
            div: '#my-map',
            lat: -23.17908,
            lng: -45.887248
        });
        map.addMarker({
            lat: startsLat,
            lng: startsLng,
            infoWindow: {
                content: '<strong>Ponto de Partida</strong>'
            }
        });
        
        // get pedidos id
        var pedidos_list = $('.sortable-item').map(
            function () {
                return $(this).attr('id');
            }
        ).get().join(',');

        $.getJSON(
            '{% url routemaker.views.pedidos_json %}', 
            { entidade: $('#my-map').data('entidade'), 'pedidos[]': [pedidos_list] }, 
            function(retorno) {
                for(var i=0; i<retorno.length; i++) {
                    var item = retorno[i];
                    if (item._Pedido__terceiro != null && item._Pedido__terceiro._Terceiro__geolocated) {

                        map.addMarker({
                            lat: item._Pedido__terceiro._Terceiro__lat,
                            lng: item._Pedido__terceiro._Terceiro__lng,
                            infoWindow: {
                                content: '<strong>' + item._Pedido__terceiro._Terceiro__nome +'</strong>'
                            }
                        });

                        map.travelRoute({
                            origin: [startsLat, startsLng],
                            destination: [item._Pedido__terceiro._Terceiro__lat, item._Pedido__terceiro._Terceiro__lng],
                            travelMode: 'driving',
                            /*callback: function(e){
                                route = new GMaps.Route({
                                  map: map,
                                  route: e[0],
                                  strokeColor: '#336699',
                                  strokeOpacity: 0.5,
                                  strokeWeight: 10
                                });

                                drawDirections(route);
                            }*/
                            step: function(e) {
                                $('#instructions').append('<li>'+e.instructions+'</li>');

                                $('#instructions li:eq(' + e.step_number + ')').delay(450 * e.step_number).fadeIn(200, function() {
                                    map.drawPolyline({
                                        path: e.path,
                                        strokeColor: '#131540',
                                        strokeOpacity: 0.6,
                                        strokeWeight: 6
                                    });
                                });
                            }
                        });

                        startsLat = item._Pedido__terceiro._Terceiro__lat;
                        startsLng = item._Pedido__terceiro._Terceiro__lng;
                    } else {
                        $('#instructions').append('<li> No directions for:'+ item._Pedido__terceiro._Terceiro__nome +'</li>');
                    }
                }
            }
        );
    }
</script> 
{% endblock %}