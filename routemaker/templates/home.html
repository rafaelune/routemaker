{% extends "base-fluid.html" %}

{% block title %}VPSA - Route Maker{% endblock %}

{% block content %}
<div class="row-fluid" style="padding-top: 50px;">
    <div class="span2">
        <div class="box">
            <strong class="database-user">{{ user_profile.database }}</strong>
            <a href="#" title="Autenticado como {{ user.username }}">{{ user.username }}</a>
        </div>
        <div class="sidebar-nav">
            <div class="well" style="padding: 8px 0;">
                <ul class="nav nav-list">
                    <li class="nav-header">Op&#231;&#245;es</li>
                    <li class="active">
                        <a href="index.html">
                            <i class="icon-map-marker"></i>
                            Criar Rota
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    
    <div class="span10">
        <div class="row-fluid">
            <div class="white-box">
                <div id="my-map" class="map-normal"></div>
            </div>
        </div>
        <hr />
        <div class="row-fluid">
            <div class="tabbable">
                <ul class="nav nav-tabs tab-menu">
                    <li class="active"><a id="lnkTab1" href="#tab1" data-toggle="tab" onclick="visual.goToFirstTabFilter();">Etapa 1</a></li>
                    <li class="d_n"><a id="lnkTab2" href="#tab2" data-toggle="tab">Etapa 2</a></li>
                    <li class="d_n"><a id="lnkTab3" href="#tab3" data-toggle="tab">Etapa 3</a></li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane active" id="tab1">
                        {% include "route/filter-form.html" %}
                    </div>
                    <div class="d_n tab-pane" id="tab2">
                        <form id="filterForm" method="post" class="well form-inline">{% csrf_token %}
                            <input type="text" id="endereco" class="input-big" placeholder="Endere&#231;o">
                            <a href="#" id="buscar" class="btn btn-small btn-info" title="Buscar pelo endere&#231;o">Buscar pelo endere&#231;o</a>
                            <a href="#" id="obter-posicao" class="btn btn-small" title="Obter minha posi&#231;&#227;o">
                                <i class="icon-screenshot"></i>
                                Obter minha posi&#231;&#227;o
                            </a>
                        </form>

                        <button id="btnNext2" disabled="disabled" class="btn-large btn disabled" onclick="loadTab3();">Pr&#243;xima</button>
                    </div>
                    <div class="d_n tab-pane" id="tab3">
                        <div class="row-fluid">
                            <ul id="instructions">
                                <li></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>

</div>

{% endblock %}

{% block scripts %}
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.18/jquery-ui.min.js"></script>
<script type="text/javascript" src="https://raw.github.com/furf/jquery-ui-touch-punch/master/jquery.ui.touch-punch.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/bootstrap-dropdown.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/bootstrap-tab.js"></script>
<script type="text/javascript" src="http://malsup.github.com/jquery.form.js"></script>
<script type="text/javascript" src="http://malsup.github.com/jquery.blockUI.js"></script>

<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
<script type="text/javascript" src="https://raw.github.com/HPNeo/gmaps/master/gmaps.js"></script>
<script type="text/javascript" src="http://j.maxmind.com/app/geoip.js"></script>

<script type="text/javascript">
    startsLat = -23.17908;
    startsLng = -45.887248;

    var map = null;

    $(document).ready(function() {
        util.createExternalLinks();
        visual.configUserMenuOptions();

        // inits the map
        map = new GMaps({
            div: '#my-map',
            lat: startsLat,
            lng: startsLng
        });

        $('#buscar').click(function() {
            getMyPositionByAddress();
        });

        $('#obter-posicao').click(function() {
            getMyPosition();
        });

        // prepare Options Object 
        var options = { 
            target:     '#pedidos-placeholder', 
            url:        '/filtro/', 
            beforeSubmit: function(arr, $form, options) {
                // saves the entidade id selected
                $('#my-map').data('entidade', arr[1].value);
                visual.showLoading();
            },
            success: function() { 
                $('#pedidos-placeholder')
                    .accordion({
                        header: "> div > h3",
                        active: false
                    })
                    .sortable({
                        connectWith: '#selected-pedidos-placeholder',
                        placeholder: 'ui-state-highlight',
                        handle: 'h3',
                        stop: function( event, ui ) {
                            /* IE doesn't register the blur when sorting
                                so trigger focusout handlers to remove .ui-state-focus
                            */
                            ui.item.children( 'h3' ).triggerHandler( 'focusout' );
                        }
                    });
                $('#pedidos-placeholder').disableSelection();
                
                $('#selected-pedidos-placeholder')
                    .accordion({
                        header: "> div > h3"
                    })
                    .sortable({
                        connectWith: '#pedidos-placeholder',
                        placeholder: 'ui-state-highlight',
                        handle: 'h3',
                        stop: function( event, ui ) {
                            /* IE doesn't register the blur when sorting
                                so trigger focusout handlers to remove .ui-state-focus
                            */
                            ui.item.children( 'h3' ).triggerHandler( 'focusout' );
                        }
                    });
                $('#selected-pedidos-placeholder').disableSelection();

                $('#btnNext1').removeClass('disabled');
                $('#btnNext1').removeAttr('disabled');

                visual.closeLoading();
            } 
        };
        // pass options to ajaxForm 
        $('#filterForm').ajaxForm(options);
    });

    function getMyPositionByAddress() {
        GMaps.geocode({
            address: $('#endereco').val(),
            callback: function(results, status) {
                if (status == 'OK') {
                    var geocode_location = results[0].geometry.location;
                    
                    startsLat = geocode_location.lat();
                    startsLng = geocode_location.lng();

                    map = new GMaps({
                        div: '#my-map',
                        lat: startsLat,
                        lng: startsLng
                    });

                    map.setCenter(geocode_location.lat(), geocode_location.lng());

                    map.addMarker({
                        lat: geocode_location.lat(),
                        lng: geocode_location.lng(),
                        infoWindow: {
                            content: '<strong>Ponto de partida</strong>'
                        }
                    });

                    $('#btnNext2').removeClass('disabled');
                    $('#btnNext2').removeAttr('disabled');
                }
            }
        });
    }

    function getMyPosition() {
        visual.showLoading();

        GMaps.geolocate({
            success: function(position) {
                startsLat = position.coords.latitude;
                startsLng = position.coords.longitude;

                map = new GMaps({
                    div: '#my-map',
                    lat: startsLat,
                    lng: startsLng
                });

                map.setCenter(position.coords.latitude, position.coords.longitude);

                map.addMarker({
                    lat: startsLat,
                    lng: startsLng,
                    infoWindow: {
                        content: '<strong>Ponto de partida</strong>'
                    }
                });

                $('#btnNext2').removeClass('disabled');
                $('#btnNext2').removeAttr('disabled');

                visual.closeLoading();
            },
            error: function(error) {
                startsLat = geoip_latitude;
                startsLng = geoip_longitude();

                // use MaxMind IP to location API fallback
                map.setCenter(startsLat, startsLng);

                map = new GMaps({
                    div: '#my-map',
                    lat: startsLat,
                    lng: startsLng
                });

                map.addMarker({
                    lat: startsLat,
                    lng: startsLng,
                    infoWindow: {
                        content: '<strong>Ponto de partida</strong>'
                    }
                });

                $('#btnNext2').removeClass('disabled');
                $('#btnNext2').removeAttr('disabled');

                visual.closeLoading();
            },
            not_supported: function() {
                startsLat = geoip_latitude;
                startsLng = geoip_longitude();

                // use MaxMind IP to location API fallback
                map.setCenter(startsLat, startsLng);

                map = new GMaps({
                    div: '#my-map',
                    lat: startsLat,
                    lng: startsLng
                });

                map.addMarker({
                    lat: startsLat,
                    lng: startsLng,
                    infoWindow: {
                        content: '<strong>Ponto de partida</strong>'
                    }
                });

                $('#btnNext2').removeClass('disabled');
                $('#btnNext2').removeAttr('disabled');

                visual.closeLoading();
            }
        });
    }

    function loadTab2() {
        visual.goToSecondTabFilter();
    }
    
    function loadTab3() {
        visual.goToThirdTabFilter();
        
        visual.showLoading();

        // get pedidos id
        var pedidos_list = $('#selected-pedidos-placeholder .sortable-item').map(
            function () {
                return $(this).attr('id');
            }
        ).get().join(',');

        var origin_lat = startsLat;
        var origin_lng = startsLng;
        var counter = 0;
        var pedidos_json = [];
        var locations = [];
        var routes = [];

        var drawRoutes = function() {

            if (counter==0) {
                origin_lat = startsLat;
                origin_lng = startsLng;
            }

            if (counter < pedidos_json.length) {
                var item = pedidos_json[counter];
                var location = locations[counter];
                var route = routes[counter];

                if (location != null) {

                    map.addMarker({
                        lat: location.lat(),
                        lng: location.lng(),
                        infoWindow: {
                            content: "<p>" +
                                     "<strong>" + item._Pedido__terceiro._Terceiro__nome + "</strong><br/>" + 
                                     "<span>Pedido: " + item._Pedido__numero + "</span><br/>" +
                                     "<span>Endere&#231;o: " + item._Pedido__terceiro._Terceiro__logradouro + "</span>" +
                                     "</p>"
                        }
                    });

                    map.drawRoute({
                        origin: [origin_lat, origin_lng],
                        destination: [location.lat(), location.lng()],
                        travelMode: 'driving',
                        strokeColor: '#336699',
                        strokeOpacity: 0.5,
                        strokeWeight: 6
                    });

                    origin_lat = location.lat();
                    origin_lng = location.lng();

                    if (route.route.legs.length > 0) {
                        var steps = route.route.legs[0].steps;
                        for (var i=0, step; step=steps[i]; i++) {
                            $('#instructions').append('<li>'+step.instructions+'</li>');
                        }
                        $('#instructions').append('<li>Chegou em <strong>' + item._Pedido__terceiro._Terceiro__logradouro + 
                            ' - pedido: ' + item._Pedido__numero + ' de '+ item._Pedido__terceiro._Terceiro__nome +'</strong></li>');
                    }
                } else {
                    $('#instructions').append('<li>Endere&#231;o <strong>' + item._Pedido__terceiro._Terceiro__logradouro + 
                            ' - pedido: ' + item._Pedido__numero + ' de '+ item._Pedido__terceiro._Terceiro__nome +'</strong> n&#227;o encontrado</li>');
                }

                counter++;
                drawRoutes();
            } else {
                visual.closeLoading();
            }
        }

        var geolocatePedidos = function() {
            if (counter < pedidos_json.length) {

                var item = pedidos_json[counter];

                GMaps.geocode({
                    address: item._Pedido__terceiro._Terceiro__logradouro
                        + ',' + item._Pedido__terceiro._Terceiro__bairro
                        + ',' + item._Pedido__terceiro._Terceiro__cidade
                        + ' - ' + item._Pedido__terceiro._Terceiro__estado,
                    callback: function(results, status) {
                        if (status == 'OK') {
                            var latlng = results[0].geometry.location;
                            locations.push(latlng);
                            
                            map.getRoutes({
                                origin: [origin_lat, origin_lng],
                                destination: [latlng.lat(), latlng.lng()],
                                travelMode: 'driving',
                                callback: function(e) {
                                    var route = new GMaps.Route({
                                        map: map,
                                        route: e[0],
                                        strokeColor: '#336699',
                                        strokeOpacity: 0.5,
                                        strokeWeight: 10
                                    });
                                    routes.push(route);
                                    counter++;
                                    geolocatePedidos(); // recursive method
                                }
                            });

                            origin_lat = latlng.lat();
                            origin_lng = latlng.lng();

                        } else {
                            locations.push(null);
                            routes.push(null);
                        }
                    }
                });
            } else {
                counter=0;
                drawRoutes();
            }
        }

        $.getJSON(
            '{% url routemaker.views.pedidos_json %}', 
            { entidade: $('#my-map').data('entidade'), 'pedidos[]': [pedidos_list] }, 
            function(retorno) {
                if (retorno.length > 0) {
                    pedidos_json = retorno;
                    $('#instructions li').remove()
                    geolocatePedidos();
                }
            }
        );
    }
</script> 
{% endblock %}